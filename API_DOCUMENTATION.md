# Admin Panel API Documentation

## Overview

All API functions are in `lib/services/couponService.ts` and use Firestore as the backend with Firebase Authentication for access control.

---

## Authentication

### useAuth Hook

```typescript
import { useAuth } from '@/lib/hooks/useAuth';

export default function MyComponent() {
  const { user, loading, error } = useAuth();

  if (loading) return <div>Loading...</div>;
  if (!user) return <div>Not authenticated</div>;

  return <div>Welcome, {user.email}</div>;
}
```

**Returns:**
- `user`: Firebase User object or null
- `loading`: Boolean indicating auth state loading
- `error`: Error message if auth failed

**Firebase User Properties:**
```typescript
{
  uid: string;           // Unique user ID
  email: string;         // User email
  displayName?: string;  // Display name
  photoURL?: string;     // Profile picture
  emailVerified: boolean;
  isAnonymous: boolean;
}
```

---

## Coupon Service API

### Types

```typescript
interface Coupon {
  id?: string;                           // Auto-generated by Firestore
  code: string;                          // Unique coupon code
  discount: number;                      // Discount value
  discountType: 'percentage' | 'fixed';  // Type of discount
  description: string;                   // Coupon description
  isActive: boolean;                     // Active status
  maxUses: number;                       // Maximum use count
  currentUses: number;                   // Current use count
  expiryDate: Timestamp | null;          // Expiration date
  createdAt?: Timestamp;                 // Creation timestamp
  updatedAt?: Timestamp;                 // Last update timestamp
}
```

---

## API Methods

### 1. Get All Coupons

```typescript
import { getCoupons } from '@/lib/services/couponService';

// Usage
const coupons = await getCoupons();

// Returns
Promise<Coupon[]>

// Example Response
[
  {
    id: 'abc123',
    code: 'SUMMER20',
    discount: 20,
    discountType: 'percentage',
    description: '20% off summer sale',
    isActive: true,
    maxUses: 1000,
    currentUses: 250,
    expiryDate: null,
    createdAt: Timestamp,
    updatedAt: Timestamp
  }
]
```

---

### 2. Get Coupon by ID

```typescript
import { getCouponById } from '@/lib/services/couponService';

// Usage
const coupon = await getCouponById('abc123');

// Returns
Promise<Coupon | null>

// If found, returns Coupon object
// If not found, returns null
```

---

### 3. Get Active Coupons Only

```typescript
import { getActiveCoupons } from '@/lib/services/couponService';

// Usage
const activeCoupons = await getActiveCoupons();

// Returns
Promise<Coupon[]>

// Only returns coupons where isActive === true
```

---

### 4. Create New Coupon

```typescript
import { createCoupon, Coupon } from '@/lib/services/couponService';

// Usage
const newCoupon: Omit<Coupon, 'id'> = {
  code: 'WELCOME10',
  discount: 10,
  discountType: 'percentage',
  description: 'Welcome discount',
  isActive: true,
  maxUses: 500,
  currentUses: 0,
  expiryDate: null
};

const result = await createCoupon(newCoupon);

// Returns
Promise<{success: boolean, id?: string, error?: any}>

// Example Response (Success)
{ success: true, id: 'newId123' }

// Example Response (Failure)
{ success: false, error: Error }
```

**Note:** `createdAt` and `updatedAt` are auto-generated.

---

### 5. Update Coupon

```typescript
import { updateCoupon, Coupon } from '@/lib/services/couponService';

// Usage
const updates: Partial<Coupon> = {
  discount: 25,
  currentUses: 251
};

const result = await updateCoupon('abc123', updates);

// Returns
Promise<{success: boolean, error?: any}>

// Example Response (Success)
{ success: true }

// Example Response (Failure)
{ success: false, error: Error }
```

**Note:** `updatedAt` is automatically set to current timestamp.

---

### 6. Delete Coupon

```typescript
import { deleteCoupon } from '@/lib/services/couponService';

// Usage
const result = await deleteCoupon('abc123');

// Returns
Promise<{success: boolean, error?: any}>

// Example Response (Success)
{ success: true }

// Example Response (Failure)
{ success: false, error: Error }
```

---

### 7. Apply / Validate Coupon

```typescript
import { applyCoupon } from '@/lib/services/couponService';

// Usage
const result = await applyCoupon('SUMMER20');

// Returns
Promise<{
  valid: boolean,
  coupon?: Coupon,
  id?: string,
  message?: string
}>

// Example Response (Valid)
{
  valid: true,
  coupon: { ... },
  id: 'abc123'
}

// Example Response (Invalid - Not found)
{
  valid: false,
  message: 'Coupon not found'
}

// Example Response (Invalid - Usage limit)
{
  valid: false,
  message: 'Coupon usage limit reached'
}

// Example Response (Invalid - Expired)
{
  valid: false,
  message: 'Coupon has expired'
}
```

**Validation Rules:**
- Coupon code must exist
- Coupon must be active (`isActive === true`)
- Current uses must not exceed max uses
- If expiry date is set, coupon must not be expired

---

## Usage Examples

### Create a Coupon

```typescript
'use client';

import { createCoupon } from '@/lib/services/couponService';
import { useState } from 'react';

export default function CreateCouponForm() {
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    const result = await createCoupon({
      code: 'NEWCODE',
      discount: 15,
      discountType: 'percentage',
      description: 'New discount code',
      isActive: true,
      maxUses: 100,
      currentUses: 0,
      expiryDate: null
    });

    if (result.success) {
      alert(`Coupon created with ID: ${result.id}`);
    } else {
      alert('Error creating coupon');
    }

    setLoading(false);
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* form fields */}
      <button type="submit" disabled={loading}>
        {loading ? 'Creating...' : 'Create Coupon'}
      </button>
    </form>
  );
}
```

### Apply Coupon in Cart

```typescript
'use client';

import { applyCoupon } from '@/lib/services/couponService';
import { useState } from 'react';

export default function CartPage() {
  const [cartTotal, setCartTotal] = useState(1000);
  const [appliedCoupon, setAppliedCoupon] = useState(null);

  const handleApplyCoupon = async (code: string) => {
    const result = await applyCoupon(code);

    if (result.valid && result.coupon) {
      setAppliedCoupon(result.coupon);

      // Calculate discount
      let discountAmount = 0;
      if (result.coupon.discountType === 'percentage') {
        discountAmount = (cartTotal * result.coupon.discount) / 100;
      } else {
        discountAmount = result.coupon.discount;
      }

      // Update total
      const newTotal = cartTotal - discountAmount;
      setCartTotal(newTotal);

      // Track usage
      // (This should be done server-side in production)

      return { success: true, discountAmount };
    } else {
      alert(result.message || 'Invalid coupon');
      return { success: false };
    }
  };

  return (
    <div>
      <div>Cart Total: AED {cartTotal}</div>
      {appliedCoupon && (
        <div>
          Discount ({appliedCoupon.code}): -{appliedCoupon.discount}
          {appliedCoupon.discountType === 'percentage' ? '%' : ' AED'}
        </div>
      )}
      <button onClick={() => handleApplyCoupon('SUMMER20')}>
        Apply Coupon
      </button>
    </div>
  );
}
```

### List and Manage Coupons

```typescript
'use client';

import { getCoupons, deleteCoupon, updateCoupon } from '@/lib/services/couponService';
import { useEffect, useState } from 'react';

export default function CouponsList() {
  const [coupons, setCoupons] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchCoupons();
  }, []);

  const fetchCoupons = async () => {
    const data = await getCoupons();
    setCoupons(data);
    setLoading(false);
  };

  const handleToggle = async (id: string, isActive: boolean) => {
    await updateCoupon(id, { isActive: !isActive });
    fetchCoupons();
  };

  const handleDelete = async (id: string) => {
    if (confirm('Delete this coupon?')) {
      await deleteCoupon(id);
      fetchCoupons();
    }
  };

  if (loading) return <div>Loading...</div>;

  return (
    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Discount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {coupons.map((coupon) => (
          <tr key={coupon.id}>
            <td>{coupon.code}</td>
            <td>{coupon.discount}{coupon.discountType === 'percentage' ? '%' : ' AED'}</td>
            <td>{coupon.isActive ? 'Active' : 'Inactive'}</td>
            <td>
              <button onClick={() => handleToggle(coupon.id, coupon.isActive)}>
                Toggle
              </button>
              <button onClick={() => handleDelete(coupon.id)}>Delete</button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  );
}
```

---

## Error Handling

### Try-Catch Pattern

```typescript
try {
  const result = await createCoupon({...});
  if (result.success) {
    console.log('Coupon created:', result.id);
  } else {
    console.error('Creation failed:', result.error);
  }
} catch (error) {
  console.error('Error:', error);
}
```

### Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| "Firebase is not initialized" | No Firebase config | Check `.env.local` |
| "Permission denied" | Firestore rules block access | Update security rules |
| "User not authenticated" | Not logged in | Redirect to login |
| "Document not found" | Invalid ID | Check ID exists |

---

## Best Practices

1. **Error Handling**: Always check `result.success`
2. **Loading States**: Show UI feedback during async operations
3. **Authentication**: Ensure user is logged in before API calls
4. **Validation**: Validate coupon codes on both client and server
5. **Performance**: Cache coupon data when possible
6. **Security**: Never expose sensitive data in client logs

---

## TypeScript Types

```typescript
// Full Coupon interface
interface Coupon {
  id?: string;
  code: string;
  discount: number;
  discountType: 'percentage' | 'fixed';
  description: string;
  isActive: boolean;
  maxUses: number;
  currentUses: number;
  expiryDate: Timestamp | null;
  createdAt?: Timestamp;
  updatedAt?: Timestamp;
}

// Create response type
type CreateResponse = {
  success: boolean;
  id?: string;
  error?: any;
};

// Update/Delete response type
type ModifyResponse = {
  success: boolean;
  error?: any;
};

// Apply response type
type ApplyResponse = {
  valid: boolean;
  coupon?: Coupon;
  id?: string;
  message?: string;
};
```

---

## Resources

- [Firebase Documentation](https://firebase.google.com/docs)
- [Firestore API Reference](https://firebase.google.com/docs/firestore/reference/rest)
- [Firebase Auth](https://firebase.google.com/docs/auth)
